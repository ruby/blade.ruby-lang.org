#!/usr/bin/env ruby

require 'optparse'
require 'mail'
require 'mail/encodings/x_gzip64'

BASE_DIR = Rails.root.join('tmp')

params = {}
OptionParser.new do |opts|
  opts.on('--local')
  opts.on('--list LIST')
  opts.on('--from FROM', Integer)
  opts.on('--to TO', Integer)
end.parse!(into: params)

list = List.find_by_name(params[:list])

errors = []

Rails.logger.level = Logger::INFO

Message.transaction do
  (params[:from]..params[:to]).each do |seq|
    begin
      if params[:local]
        filepath = BASE_DIR.join(list.name, seq.to_s)
        raise "No #{seq.to_s}" unless filepath.exist?
        next
        next unless filepath.exist?

        str = File.binread filepath
        next if str.blank?

        mail = Mail.read_from_string str
        message = Message.from_mail mail, list, seq
      else
        message = Message.from_s3(list, seq)
      end

      p seq if seq % 10 == 0
      message.save!
    rescue ActiveRecord::RecordNotUnique
      STDERR.puts("#{list.name}:#{seq} already exists in Postgres")
    rescue Aws::S3::Errors::NoSuchKey
      STDERR.puts("#{list.name}:#{seq} doesn't exist in S3")
    rescue StandardError => e
      errors << [seq, e]
      STDERR.puts("failed to import #{list.name}:#{seq}: #{e}")
    end
  end
end

pp errors if errors.any?
